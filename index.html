<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="cf-2fa-verify" content="no-email-obfuscation">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biology Professor Survey — Student Preparedness in College Biology</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0d1f3c;
    --navy-mid: #152c52;
    --navy-light: #1e3d6e;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --cream: #f8f5ef;
    --cream-dark: #ede8df;
    --sage: #4a7c6f;
    --sage-light: #6aaa99;
    --red-accent: #a63d2f;
    --purple-ai: #6b3fa0;
    --purple-light: #f0eafa;
    --text-dark: #1a1a2e;
    --text-mid: #3d4660;
    --text-light: #6b7280;
    --white: #ffffff;
    --border: rgba(13,31,60,0.12);
    --shadow-sm: 0 2px 8px rgba(13,31,60,0.08);
    --shadow-md: 0 8px 32px rgba(13,31,60,0.12);
    --shadow-lg: 0 24px 64px rgba(13,31,60,0.18);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--text-dark);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ─── VIEWS ─────────────────────────────────── */
  .view { display: none; min-height: 100vh; }
  .view.active { display: block; }

  /* ─── HOMEPAGE ─────────────────────────────── */
  #home {
    background: var(--cream);
    position: relative;
  }

  .home-hero {
    background: var(--navy);
    position: relative;
    overflow: hidden;
    padding: 80px 48px 100px;
    text-align: center;
  }

  .home-hero::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 60% at 20% 120%, rgba(201,168,76,0.18) 0%, transparent 60%),
      radial-gradient(ellipse 60% 80% at 80% -20%, rgba(106,170,153,0.12) 0%, transparent 60%);
  }

  .dna-pattern {
    position: absolute;
    top: 0; right: 0;
    width: 320px; height: 100%;
    opacity: 0.04;
    background-image: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 10px,
      rgba(255,255,255,0.5) 10px,
      rgba(255,255,255,0.5) 11px
    );
  }

  .hero-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 24px;
    position: relative;
  }

  .hero-eyebrow::before, .hero-eyebrow::after {
    content: '——';
    margin: 0 12px;
    opacity: 0.5;
  }

  .hero-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(32px, 5vw, 60px);
    font-weight: 300;
    color: var(--white);
    line-height: 1.15;
    max-width: 820px;
    margin: 0 auto 20px;
    position: relative;
  }

  .hero-title em {
    font-style: italic;
    color: var(--gold-light);
  }

  .hero-subtitle {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    font-weight: 300;
    color: rgba(255,255,255,0.65);
    font-style: italic;
    margin-bottom: 48px;
    position: relative;
  }

  .hero-cta {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    background: var(--gold);
    color: var(--navy);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 16px 40px;
    border: none;
    cursor: pointer;
    position: relative;
    transition: all 0.25s ease;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  .hero-cta:hover {
    background: var(--gold-light);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(201,168,76,0.4);
  }

  .hero-cta svg { width: 18px; height: 18px; }

  .home-body {
    max-width: 900px;
    margin: 0 auto;
    padding: 64px 48px;
  }

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    margin-bottom: 56px;
  }

  .info-card {
    background: var(--white);
    border: 1px solid var(--border);
    padding: 32px;
    position: relative;
    box-shadow: var(--shadow-sm);
  }

  .info-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 3px; height: 100%;
    background: var(--gold);
  }

  .info-card h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 500;
    color: var(--navy);
    margin-bottom: 12px;
  }

  .info-card p {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-mid);
  }

  .about-section {
    background: var(--navy);
    color: var(--white);
    padding: 48px;
    margin-bottom: 56px;
    position: relative;
    overflow: hidden;
  }

  .about-section::after {
    content: '"';
    position: absolute;
    right: 32px;
    bottom: -20px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 200px;
    color: rgba(255,255,255,0.04);
    line-height: 1;
  }

  .about-section h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 28px;
    font-weight: 400;
    color: var(--gold-light);
    margin-bottom: 20px;
  }

  .about-section p {
    font-size: 15px;
    line-height: 1.8;
    color: rgba(255,255,255,0.8);
    max-width: 700px;
    margin-bottom: 16px;
  }

  .about-section p:last-child { margin-bottom: 0; }

  .contact-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--gold-light);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    padding: 8px 16px;
    margin-top: 20px;
  }

  .sections-list {
    margin-bottom: 56px;
  }

  .sections-list h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 30px;
    font-weight: 400;
    color: var(--navy);
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .section-item {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    padding: 20px 0;
    border-bottom: 1px solid var(--cream-dark);
  }

  .section-number {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    background: var(--navy);
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    font-weight: 500;
  }

  .section-item h4 {
    font-size: 15px;
    font-weight: 600;
    color: var(--navy);
    margin-bottom: 4px;
  }

  .section-item p {
    font-size: 13px;
    color: var(--text-light);
    line-height: 1.5;
  }

  .ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--purple-ai);
    background: var(--purple-light);
    border: 1px solid rgba(107,63,160,0.2);
    padding: 2px 8px;
    margin-left: 8px;
    vertical-align: middle;
  }

  .start-survey-block {
    text-align: center;
    padding: 48px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    margin-bottom: 0;
  }

  .start-survey-block h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 34px;
    font-weight: 300;
    color: var(--white);
    margin-bottom: 12px;
  }

  .start-survey-block p {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 32px;
  }

  /* Admin login button */
  .admin-login-btn {
    position: fixed;
    bottom: 28px;
    right: 28px;
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--white);
    border: 1px solid var(--border);
    color: var(--text-mid);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    padding: 10px 18px;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    transition: all 0.2s;
    z-index: 100;
  }

  .admin-login-btn:hover {
    background: var(--navy);
    color: var(--gold);
    border-color: var(--navy);
  }

  .admin-login-btn svg { width: 14px; height: 14px; }

  /* ─── MODAL ─────────────────────────────────── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(13,31,60,0.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--white);
    width: 400px;
    max-width: 95vw;
    padding: 40px;
    box-shadow: var(--shadow-lg);
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: 16px; right: 16px;
    background: none; border: none;
    cursor: pointer; color: var(--text-light);
    font-size: 20px; line-height: 1;
    transition: color 0.2s;
  }

  .modal-close:hover { color: var(--red-accent); }

  .modal h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 26px;
    font-weight: 400;
    color: var(--navy);
    margin-bottom: 8px;
  }

  .modal p { font-size: 13px; color: var(--text-light); margin-bottom: 24px; }

  .form-group { margin-bottom: 20px; }

  .form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-mid);
    margin-bottom: 8px;
  }

  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    border: 1px solid var(--border);
    padding: 12px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text-dark);
    background: var(--cream);
    outline: none;
    transition: border-color 0.2s;
  }

  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: var(--navy);
    background: var(--white);
  }

  .error-msg {
    color: var(--red-accent);
    font-size: 13px;
    margin-top: 8px;
    display: none;
  }

  .btn-primary {
    width: 100%;
    background: var(--navy);
    color: var(--white);
    border: none;
    padding: 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary:hover { background: var(--navy-light); }

  .btn-secondary {
    background: var(--white);
    color: var(--navy);
    border: 1px solid var(--navy);
    padding: 12px 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-secondary:hover { background: var(--navy); color: var(--white); }

  /* ─── SURVEY VIEW ───────────────────────────── */
  #survey {
    background: var(--cream);
  }

  .survey-header {
    background: var(--navy);
    padding: 28px 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
    box-shadow: var(--shadow-md);
  }

  .survey-header-left h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 400;
    color: var(--white);
  }

  .survey-header-left p {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .progress-wrap {
    text-align: right;
  }

  .progress-label {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    margin-bottom: 6px;
  }

  .progress-bar {
    width: 220px;
    height: 4px;
    background: rgba(255,255,255,0.15);
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: var(--gold);
    transition: width 0.4s ease;
  }

  .survey-body {
    max-width: 820px;
    margin: 0 auto;
    padding: 48px 32px 80px;
  }

  .section-header {
    border-left: 4px solid var(--gold);
    padding-left: 20px;
    margin-bottom: 36px;
    margin-top: 8px;
  }

  .section-num-badge {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .section-header h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 30px;
    font-weight: 400;
    color: var(--navy);
  }

  .section-note {
    font-size: 13px;
    font-style: italic;
    color: var(--text-light);
    margin-top: 8px;
    line-height: 1.6;
  }

  .question-block {
    background: var(--white);
    border: 1px solid var(--border);
    padding: 28px 32px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
    transition: border-color 0.2s;
  }

  .question-block:focus-within {
    border-color: rgba(13,31,60,0.3);
  }

  .question-block.ai-question {
    border-left: 4px solid var(--purple-ai);
    background: var(--purple-light);
  }

  .question-block.ai-question .q-label {
    color: var(--purple-ai);
  }

  .ai-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    color: var(--purple-ai);
    background: rgba(107,63,160,0.1);
    border: 1px solid rgba(107,63,160,0.25);
    padding: 3px 8px;
    margin-bottom: 8px;
  }

  .q-text {
    font-size: 15px;
    font-weight: 500;
    color: var(--text-dark);
    line-height: 1.55;
    margin-bottom: 20px;
  }

  .q-num {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    font-weight: 500;
    margin-bottom: 6px;
  }

  /* Radio/checkbox options */
  .options-list { display: flex; flex-direction: column; gap: 10px; }

  .option-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
    border: 1px solid var(--border);
    background: var(--cream);
    cursor: pointer;
    transition: all 0.15s;
    font-size: 14px;
    line-height: 1.5;
  }

  .option-label:hover {
    border-color: var(--navy);
    background: rgba(13,31,60,0.03);
  }

  .option-label input[type="radio"],
  .option-label input[type="checkbox"] {
    margin-top: 2px;
    flex-shrink: 0;
    accent-color: var(--navy);
    width: 16px;
    height: 16px;
  }

  .option-label.selected {
    background: rgba(13,31,60,0.06);
    border-color: var(--navy);
  }

  /* Likert scale */
  .likert-wrap {
    overflow-x: auto;
  }

  .likert-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 420px;
  }

  .likert-table th {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-light);
    text-align: center;
    padding: 8px 6px;
    border-bottom: 2px solid var(--border);
    line-height: 1.3;
  }

  .likert-table td {
    text-align: center;
    padding: 10px 6px;
  }

  .likert-table td input[type="radio"] {
    width: 18px;
    height: 18px;
    accent-color: var(--navy);
    cursor: pointer;
  }

  /* Open-ended textarea */
  .survey-textarea {
    width: 100%;
    border: 1px solid var(--border);
    padding: 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text-dark);
    background: var(--cream);
    resize: vertical;
    min-height: 100px;
    outline: none;
    transition: border-color 0.2s;
    line-height: 1.6;
  }

  .survey-textarea:focus {
    border-color: var(--navy);
    background: var(--white);
  }

  /* Sub-item questions */
  .sub-question {
    padding: 16px 0;
    border-bottom: 1px solid var(--cream-dark);
  }

  .sub-question:last-child { border-bottom: none; }

  .sub-q-label {
    font-size: 14px;
    color: var(--text-mid);
    margin-bottom: 12px;
    display: flex;
    gap: 8px;
  }

  .sub-q-label strong {
    color: var(--navy);
    font-weight: 600;
    flex-shrink: 0;
  }

  .survey-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 32px 0 0;
    border-top: 1px solid var(--border);
    margin-top: 40px;
  }

  .nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 32px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .nav-btn-prev {
    background: var(--white);
    color: var(--navy);
    border: 1px solid var(--border);
  }

  .nav-btn-prev:hover { border-color: var(--navy); }

  .nav-btn-next {
    background: var(--navy);
    color: var(--white);
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  .nav-btn-next:hover { background: var(--navy-light); }

  .nav-btn-submit {
    background: var(--sage);
    color: var(--white);
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  .nav-btn-submit:hover { background: var(--sage-light); }

  .section-pill {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-light);
  }

  /* Success screen */
  .success-screen {
    text-align: center;
    padding: 80px 48px;
    max-width: 600px;
    margin: 0 auto;
  }

  .success-icon {
    width: 72px; height: 72px;
    background: var(--sage);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 32px;
  }

  .success-icon svg { width: 36px; height: 36px; color: white; }

  .success-screen h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 40px;
    font-weight: 300;
    color: var(--navy);
    margin-bottom: 16px;
  }

  .success-screen p {
    font-size: 15px;
    color: var(--text-mid);
    line-height: 1.7;
    margin-bottom: 16px;
  }

  /* ─── ADMIN VIEW ────────────────────────────── */
  #admin {
    display: none;
    background: #f0f2f5;
    min-height: 100vh;
  }

  #admin.active { display: block; }

  .admin-sidebar {
    position: fixed;
    top: 0; left: 0;
    width: 260px;
    height: 100vh;
    background: var(--navy);
    display: flex;
    flex-direction: column;
    z-index: 200;
    overflow-y: auto;
  }

  .admin-logo {
    padding: 28px 24px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }

  .admin-logo h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    font-weight: 400;
    color: var(--white);
    line-height: 1.3;
  }

  .admin-logo p {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--gold);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 4px;
  }

  .admin-nav { padding: 16px 0; flex: 1; }

  .admin-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 24px;
    color: rgba(255,255,255,0.55);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    border-left: 3px solid transparent;
  }

  .admin-nav-item:hover {
    color: var(--white);
    background: rgba(255,255,255,0.05);
  }

  .admin-nav-item.active {
    color: var(--white);
    background: rgba(201,168,76,0.1);
    border-left-color: var(--gold);
  }

  .admin-nav-item svg { width: 16px; height: 16px; }

  .admin-logout {
    padding: 20px 24px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }

  .admin-logout button {
    display: flex;
    align-items: center;
    gap: 8px;
    background: none;
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.5);
    padding: 8px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    width: 100%;
    justify-content: center;
  }

  .admin-logout button:hover {
    border-color: rgba(255,255,255,0.4);
    color: var(--white);
  }

  .admin-main {
    margin-left: 260px;
    padding: 40px;
    min-height: 100vh;
  }

  .admin-tab { display: none; }
  .admin-tab.active { display: block; }

  .admin-page-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 36px;
    font-weight: 300;
    color: var(--navy);
    margin-bottom: 8px;
  }

  .admin-page-sub {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 36px;
  }

  /* Stats cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 40px;
  }

  .stat-card {
    background: var(--white);
    border: 1px solid var(--border);
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .stat-card .stat-val {
    font-family: 'Cormorant Garamond', serif;
    font-size: 48px;
    font-weight: 300;
    color: var(--navy);
    line-height: 1;
    margin-bottom: 6px;
  }

  .stat-card .stat-label {
    font-size: 12px;
    color: var(--text-light);
    font-weight: 500;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .stat-card .stat-sub {
    font-size: 12px;
    color: var(--sage);
    margin-top: 4px;
  }

  /* Charts / aggregate */
  .agg-section {
    background: var(--white);
    border: 1px solid var(--border);
    padding: 32px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-sm);
  }

  .agg-section h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 400;
    color: var(--navy);
    margin-bottom: 6px;
  }

  .agg-section .agg-q {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 20px;
    font-style: italic;
  }

  .bar-chart { display: flex; flex-direction: column; gap: 10px; }

  .bar-row {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
  }

  .bar-row-label {
    width: 220px;
    flex-shrink: 0;
    color: var(--text-mid);
    text-align: right;
    line-height: 1.3;
    font-size: 12px;
  }

  .bar-track {
    flex: 1;
    height: 24px;
    background: var(--cream-dark);
    position: relative;
  }

  .bar-fill {
    height: 100%;
    background: var(--navy);
    transition: width 0.6s ease;
  }

  .bar-count {
    width: 60px;
    flex-shrink: 0;
    color: var(--text-light);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
  }

  .avg-score {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--navy);
    color: var(--white);
    padding: 8px 20px;
    font-size: 14px;
    margin-bottom: 16px;
  }

  .avg-score strong {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px;
    font-weight: 300;
  }

  /* Responses table */
  .responses-toolbar {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    align-items: center;
  }

  .search-input {
    border: 1px solid var(--border);
    padding: 10px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    background: var(--white);
    outline: none;
    width: 260px;
    transition: border-color 0.2s;
  }

  .search-input:focus { border-color: var(--navy); }

  .responses-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--white);
    box-shadow: var(--shadow-sm);
    font-size: 13px;
  }

  .responses-table th {
    background: var(--navy);
    color: var(--gold);
    text-align: left;
    padding: 12px 16px;
    font-weight: 600;
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .responses-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--cream-dark);
    color: var(--text-mid);
    vertical-align: top;
  }

  .responses-table tr:hover td { background: var(--cream); }

  .view-response-btn {
    background: var(--navy);
    color: var(--white);
    border: none;
    padding: 6px 14px;
    font-size: 11px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: background 0.15s;
  }

  .view-response-btn:hover { background: var(--navy-light); }

  .delete-btn {
    background: none;
    border: 1px solid var(--red-accent);
    color: var(--red-accent);
    padding: 5px 12px;
    font-size: 11px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.15s;
    margin-left: 6px;
  }

  .delete-btn:hover { background: var(--red-accent); color: white; }

  /* Settings tab */
  .settings-card {
    background: var(--white);
    border: 1px solid var(--border);
    padding: 36px;
    max-width: 500px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 24px;
  }

  .settings-card h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 400;
    color: var(--navy);
    margin-bottom: 4px;
  }

  .settings-card p {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 24px;
  }

  .success-toast {
    display: none;
    background: var(--sage);
    color: var(--white);
    padding: 12px 20px;
    font-size: 13px;
    margin-top: 12px;
  }

  /* Response detail modal */
  .response-detail {
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
    width: 95vw;
  }

  .response-detail h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 26px;
    color: var(--navy);
    margin-bottom: 4px;
  }

  .response-detail .response-meta {
    font-size: 12px;
    color: var(--text-light);
    font-family: 'DM Mono', monospace;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .response-item {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--cream-dark);
  }

  .response-item:last-child { border-bottom: none; }

  .response-item .r-q {
    font-size: 13px;
    font-weight: 600;
    color: var(--navy);
    margin-bottom: 6px;
    line-height: 1.4;
  }

  .response-item .r-a {
    font-size: 13px;
    color: var(--text-mid);
    line-height: 1.6;
    background: var(--cream);
    padding: 10px 14px;
    border-left: 3px solid var(--border);
  }

  .empty-state {
    text-align: center;
    padding: 60px 40px;
    color: var(--text-light);
  }

  .empty-state svg {
    width: 48px; height: 48px;
    margin: 0 auto 16px;
    display: block;
    opacity: 0.3;
  }

  .empty-state h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px;
    color: var(--text-mid);
    margin-bottom: 8px;
  }

  /* Animations */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-in {
    animation: fadeUp 0.4s ease forwards;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .loading { display: inline-block; animation: spin 1s linear infinite; }

  /* Responsive */
  @media (max-width: 768px) {
    .info-grid { grid-template-columns: 1fr; }
    .home-hero { padding: 48px 24px 64px; }
    .home-body { padding: 40px 24px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .admin-sidebar { width: 220px; }
    .admin-main { margin-left: 220px; padding: 24px; }
  }
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════ HOME VIEW -->
<div id="home" class="view active">
  <div class="home-hero">
    <div class="dna-pattern"></div>
    <div class="hero-eyebrow">Academic Research Survey · 2025–2026</div>
    <h1 class="hero-title">Survey for Biology Professors at <em>Major Academic Institutions</em></h1>
    <p class="hero-subtitle">Student Preparedness, Critical Thinking &amp; Pedagogical Practices in College Biology</p>
    <button class="hero-cta" onclick="startSurvey()">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
      Begin Survey
    </button>
  </div>

  <div class="home-body">
    <div class="info-grid">
      <div class="info-card">
        <h3>Purpose</h3>
        <p>This survey gathers evidence from college biology faculty on the trends they observe in incoming students — particularly those who have completed AP Biology — to better understand gaps in college preparedness.</p>
      </div>
      <div class="info-card">
        <h3>Who Should Respond</h3>
        <p>This survey is intended for biology professors and instructors who teach introductory-level college biology courses and regularly interact with incoming freshmen or sophomore students.</p>
      </div>
      <div class="info-card">
        <h3>Time Commitment</h3>
        <p>The survey contains 9 sections and approximately 55 questions. Most responses are multiple-choice or rating scales. Estimated completion time is <strong>20–25 minutes</strong>.</p>
      </div>
      <div class="info-card">
        <h3>Confidentiality</h3>
        <p>All responses are anonymous and will be reported only in aggregate. No personally identifiable information is collected. Your participation is entirely voluntary.</p>
      </div>
    </div>

    <div class="about-section">
      <h2>About This Survey</h2>
      <p>The transition from high school to college-level biology represents one of the most academically significant steps in a student's scientific education. This survey seeks to understand — from the perspective of those who receive these students — what is working, what is not, and how individual high school biology teachers can better align their instruction with the demands of college coursework.</p>
      <p>Topics covered include foundational content knowledge, critical thinking and scientific reasoning, laboratory skills, study habits, academic resilience, and the increasingly important role of technology and artificial intelligence tools in student learning.</p>
      <p>This survey was designed and is administered by:</p>
      <div class="contact-chip">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        Dustin Houghton, PhD &middot; AP Biology Teacher &middot; dhoughto&#64;ccs&#46;k12&#46;in&#46;us
      </div>
    </div>

    <div class="sections-list">
      <h2>Survey Sections</h2>
      <div class="section-item">
        <div class="section-number">01</div>
        <div>
          <h4>Respondent Background</h4>
          <p>Institution type, years of experience, primary teaching area, AP Biology student exposure</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">02</div>
        <div>
          <h4>Overall Academic Preparedness</h4>
          <p>General preparedness ratings and observed trends over the past five years</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">03</div>
        <div>
          <h4>Foundational Biology Knowledge</h4>
          <p>Cell biology, genetics, biochemistry, evolution, ecology, and vocabulary</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">04</div>
        <div>
          <h4>Critical Thinking &amp; Scientific Reasoning</h4>
          <p>Experimental design, data interpretation, evidence evaluation, novel application</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">05</div>
        <div>
          <h4>Laboratory Skills</h4>
          <p>Equipment use, protocols, data recording, safety, and virtual lab technology</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">06</div>
        <div>
          <h4>Academic &amp; Study Skills</h4>
          <p>Scientific literacy, writing, time management, persistence, and AI tool use policies</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">07</div>
        <div>
          <h4>Recommendations for AP Biology Teachers</h4>
          <p>What teachers can do more of, less of, and how to integrate AI responsibly</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">08</div>
        <div>
          <h4>College Classroom Policies</h4>
          <p>Grading structure, reassessment policies, late work, and AI detection practices</p>
        </div>
      </div>
      <div class="section-item">
        <div class="section-number">09</div>
        <div>
          <h4>Final Reflections</h4>
          <p>Overall preparedness score, messages to AP teachers, AI's future role in biology education</p>
        </div>
      </div>
    </div>

    <div class="start-survey-block">
      <h2>Ready to contribute?</h2>
      <p>Your insights directly inform how AP Biology teachers prepare the next generation of scientists.</p>
      <button class="hero-cta" onclick="startSurvey()">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
        Begin the Survey
      </button>
    </div>
  </div>

  <!-- Admin login button -->
  <button class="admin-login-btn" onclick="openAdminModal()">
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    Administrator Login
  </button>
</div>

<!-- ═══════════════════════════════════════════════════════ SURVEY VIEW -->
<div id="survey" class="view">
  <div class="survey-header">
    <div class="survey-header-left">
      <h2>Biology Professor Survey</h2>
      <p id="current-section-label">Section 1 of 9</p>
    </div>
    <div class="progress-wrap">
      <div class="progress-label" id="progress-label">Section 1 of 9</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:11%"></div></div>
    </div>
  </div>

  <div class="survey-body" id="survey-body">
    <!-- Injected by JS -->
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════ ADMIN VIEW -->
<div id="admin" class="view">
  <div class="admin-sidebar">
    <div class="admin-logo">
      <h1>Survey Administrator</h1>
      <p>Biology Preparedness Study</p>
    </div>
    <nav class="admin-nav">
      <div class="admin-nav-item active" onclick="showAdminTab('dashboard')">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Dashboard
      </div>
      <div class="admin-nav-item" onclick="showAdminTab('responses')">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Individual Responses
      </div>
      <div class="admin-nav-item" onclick="showAdminTab('settings')">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
        Settings
      </div>
    </nav>
    <div class="admin-logout">
      <button onclick="adminLogout()">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        Log Out
      </button>
    </div>
  </div>

  <div class="admin-main">
    <!-- DASHBOARD TAB -->
    <div id="tab-dashboard" class="admin-tab active">
      <h1 class="admin-page-title">Survey Dashboard</h1>
      <p class="admin-page-sub">Aggregate results across all submitted responses.</p>

      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="stat-total">—</div>
          <div class="stat-label">Total Responses</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-avg-prep">—</div>
          <div class="stat-label">Avg. Preparedness Score</div>
          <div class="stat-sub">Out of 10</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-trend">—</div>
          <div class="stat-label">Most Common Trend</div>
          <div class="stat-sub">Preparedness direction</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-ai-detect">—</div>
          <div class="stat-label">Report Detecting AI</div>
          <div class="stat-sub">In student submissions</div>
        </div>
      </div>

      <div id="aggregate-charts">
        <!-- Populated by JS -->
        <div class="empty-state">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
          <h3>No responses yet</h3>
          <p>Aggregate charts will appear here once responses are submitted.</p>
        </div>
      </div>
    </div>

    <!-- RESPONSES TAB -->
    <div id="tab-responses" class="admin-tab">
      <h1 class="admin-page-title">Individual Responses</h1>
      <p class="admin-page-sub">Browse and review each submission in detail.</p>

      <div class="responses-toolbar">
        <input type="text" class="search-input" id="response-search" placeholder="Search by institution type, date…" oninput="filterResponses()">
        <span id="response-count-label" style="font-size:13px;color:var(--text-light);"></span>
      </div>

      <div id="responses-table-wrap"></div>
    </div>

    <!-- SETTINGS TAB -->
    <div id="tab-settings" class="admin-tab">
      <h1 class="admin-page-title">Settings</h1>
      <p class="admin-page-sub">Manage your administrator account preferences.</p>

      <div class="settings-card">
        <h3>Change Administrator Password</h3>
        <p>Update the password used to access this administrator portal.</p>
        <div class="form-group">
          <label>Current Password</label>
          <input type="password" id="settings-current-pw" placeholder="Enter current password">
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="settings-new-pw" placeholder="Enter new password">
        </div>
        <div class="form-group">
          <label>Confirm New Password</label>
          <input type="password" id="settings-confirm-pw" placeholder="Confirm new password">
        </div>
        <div class="error-msg" id="settings-error"></div>
        <button class="btn-primary" onclick="changePassword()" style="margin-top:8px;">Update Password</button>
        <div class="success-toast" id="settings-success">✓ Password updated successfully.</div>
      </div>

      <div class="settings-card">
        <h3>Export Data</h3>
        <p>Download all survey responses as a JSON file for backup or external analysis.</p>
        <button class="btn-secondary" onclick="exportData()">Download JSON Export</button>
      </div>

      <div class="settings-card" style="border-top: 3px solid var(--red-accent);">
        <h3 style="color:var(--red-accent);">Danger Zone</h3>
        <p>Permanently delete all survey responses. This action cannot be undone.</p>
        <button class="btn-secondary" style="border-color:var(--red-accent);color:var(--red-accent);" onclick="confirmDeleteAll()">Delete All Responses</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════ MODALS -->
<!-- Admin Login Modal -->
<div class="modal-overlay" id="admin-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeAdminModal()">✕</button>
    <h3>Administrator Login</h3>
    <p>Enter your password to access the survey administration portal.</p>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="admin-pw-input" placeholder="Enter password" onkeydown="if(event.key==='Enter')checkAdminLogin()">
    </div>
    <div class="error-msg" id="login-error">Incorrect password. Please try again.</div>
    <button class="btn-primary" onclick="checkAdminLogin()">Log In</button>
  </div>
</div>

<!-- Response Detail Modal -->
<div class="modal-overlay" id="response-modal">
  <div class="modal response-detail">
    <button class="modal-close" onclick="closeResponseModal()">✕</button>
    <div id="response-detail-content"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════ STATE & STORAGE (API-backed)

async function apiPost(url, body) {
  const r = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return { ok: r.ok, status: r.status, data: await r.json().catch(()=>({})) };
}

async function apiGet(url) {
  const r = await fetch(url);
  return { ok: r.ok, status: r.status, data: await r.json().catch(()=>({})) };
}

async function apiDelete(url) {
  const r = await fetch(url, { method: 'DELETE' });
  return { ok: r.ok, status: r.status, data: await r.json().catch(()=>({})) };
}

async function addResponse(data) {
  await apiPost('/api/responses', data);
}

// ═══════════════════════════════════ SURVEY DEFINITION
// Each question: { id, section, sectionTitle, sectionNote, type, text, options, sub, isAI, required }
// types: radio, checkbox, likert, textarea, number, sub_likert

const SECTIONS = [
  { num: 1, title: "Respondent Background", note: "Background information used to compare responses across institution types, disciplines, and experience levels." },
  { num: 2, title: "Overall Academic Preparedness", note: "Rate your observations based on students beginning your introductory biology course — regardless of whether they took AP Biology." },
  { num: 3, title: "Foundational Biology Knowledge", note: "Rate how well students demonstrate each competency upon arrival. Scale: 1 = Very Poor · 2 = Below Average · 3 = Average · 4 = Above Average · 5 = Excellent" },
  { num: 4, title: "Critical Thinking & Scientific Reasoning", note: "Rate student competencies on the same 1–5 scale." },
  { num: 5, title: "Laboratory Skills & Scientific Practice", note: "" },
  { num: 6, title: "Academic & Study Skills", note: "" },
  { num: 7, title: "Recommendations — What AP Teachers Can Do", note: "Your perspectives on what high school AP Biology teachers could do to better prepare students for college. Focus on what is within a teacher's direct control." },
  { num: 8, title: "College Classroom Policies", note: "Your own classroom practices and policies — helps high school teachers understand how college biology is typically structured." },
  { num: 9, title: "Final Reflections", note: "" },
];

const QUESTIONS = [
  // SECTION 1
  { id:'q1', sec:1, type:'radio', text:'What type of institution do you teach at?', options:['R1/R2 Doctoral University (high or very high research activity)','Master\'s University','Liberal Arts College / Baccalaureate College','Community College or Two-Year Institution','Other'] },
  { id:'q2', sec:1, type:'radio', text:'How many years have you taught introductory biology courses at the college level?', options:['Fewer than 3 years','3–7 years','8–15 years','More than 15 years'] },
  { id:'q3', sec:1, type:'radio', text:'What is your primary teaching area within biology?', options:['Cell and Molecular Biology','Genetics / Genomics','Ecology / Environmental Biology','Physiology / Anatomy','Evolution / Organismal Biology','Biochemistry','General / Introductory Biology (broad)','Other'] },
  { id:'q4', sec:1, type:'radio', text:'Approximately what percentage of students in your introductory biology course arrive having taken AP Biology in high school?', options:['Less than 10%','10–25%','26–50%','51–75%','More than 75%','I do not know / do not have this information'] },
  { id:'q5', sec:1, type:'likert', isAI:true, text:'How comfortable are you personally with using technology and AI tools in an academic or instructional setting?', options:['Very Uncomfortable','Somewhat Uncomfortable','Neutral','Somewhat Comfortable','Very Comfortable'] },

  // SECTION 2
  { id:'q6', sec:2, type:'likert', text:'How would you rate the overall academic preparedness of incoming students for college-level biology?', options:['Very Underprepared','Somewhat Underprepared','Adequately Prepared','Well Prepared','Exceptionally Prepared'] },
  { id:'q7', sec:2, type:'radio', text:'How would you describe the trend in incoming student preparedness over the past five years?', options:['Students have become noticeably more prepared','Students have become somewhat more prepared','Preparedness has remained about the same','Students have become somewhat less prepared','Students have become noticeably less prepared','I have not been teaching long enough to observe a trend'] },
  { id:'q8', sec:2, type:'textarea', text:'Please describe any specific changes in student preparedness you have observed over time:' },
  { id:'q9', sec:2, type:'radio', isAI:true, text:'Have you noticed changes — positive or negative — in student preparedness that you believe may be related to increased use of AI tools (such as ChatGPT, Claude, Gemini, or similar) in high school?', options:['Yes, I have noticed changes I believe are positively related to AI tool use','Yes, I have noticed changes I believe are negatively related to AI tool use','I have noticed changes but cannot attribute them to AI tool use specifically','I have not noticed any changes I would attribute to AI tool use','I do not have enough information to assess this'] },
  { id:'q10', sec:2, type:'textarea', isAI:true, text:'Please describe any observations you have made about how AI tool use may be affecting student preparedness:' },

  // SECTION 3
  { id:'q11', sec:3, type:'likert', text:'Core cell biology concepts (cell structure, membranes, organelles, cell cycle):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q12', sec:3, type:'likert', text:'Genetics and heredity (Mendelian genetics, gene expression, mutations):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q13', sec:3, type:'likert', text:'Biochemistry fundamentals (macromolecules, enzyme function, metabolism pathways):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q14', sec:3, type:'likert', text:'Understanding of evolution and natural selection:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q15', sec:3, type:'likert', text:'Understanding of ecology and biological systems:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q16', sec:3, type:'likert', text:'Breadth and retention of biological vocabulary (ability to recall and apply key terms):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q17', sec:3, type:'textarea', text:'Are there specific content areas where you consistently observe significant knowledge gaps? If so, please describe them:' },
  { id:'q18', sec:3, type:'radio', isAI:true, text:'Do you believe students are using AI tools to look up biology content instead of deeply learning it? If so, how does this affect their foundational knowledge?', options:['Yes, and I believe it is reducing the depth of their content knowledge','Yes, but I believe it has little effect on the depth of their knowledge','Possibly, but I have no strong evidence either way','No, I do not believe this is a significant pattern','I have not observed this'] },
  { id:'q19', sec:3, type:'textarea', isAI:true, text:'Please describe any specific observations about AI use and student content knowledge:' },

  // SECTION 4
  { id:'q20', sec:4, type:'likert', text:'Ability to design a simple experiment (identify variables, controls, hypotheses):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q21', sec:4, type:'likert', text:'Ability to interpret graphical and tabular data (graphs, charts, tables):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q22', sec:4, type:'likert', text:'Ability to evaluate evidence and draw scientifically valid conclusions:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q23', sec:4, type:'likert', text:'Ability to apply biological concepts to novel or unfamiliar scenarios:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q24', sec:4, type:'likert', text:'Ability to synthesize information from multiple sources or readings:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q25', sec:4, type:'radio', text:'In your experience, how do students who took AP Biology compare to non-AP students in terms of scientific reasoning and critical thinking?', options:['AP Biology students demonstrate noticeably stronger critical thinking skills','AP Biology students demonstrate somewhat stronger critical thinking skills','There is no consistent difference between the two groups','AP Biology students demonstrate somewhat weaker critical thinking in some areas','AP Biology students demonstrate noticeably weaker critical thinking in some areas','I have not observed a pattern I am confident about'] },
  { id:'q26', sec:4, type:'textarea', text:'Please elaborate on any critical thinking patterns you have observed (AP vs. non-AP students):' },
  { id:'q27', sec:4, type:'likert', isAI:true, text:'In your observation, how does student reliance on AI tools appear to affect critical thinking and scientific reasoning?', options:['Strongly Negative','Somewhat Negative','No Effect','Somewhat Positive','Strongly Positive'] },
  { id:'q28', sec:4, type:'radio', isAI:true, text:'Have you observed students submitting work you believe was generated or substantially assisted by AI?', options:['Yes, frequently (more than 25% of submitted work)','Yes, occasionally (roughly 10–25% of submitted work)','Yes, but rarely (fewer than 10% of submitted work)','No, I have not observed this','I do not assess work in a way that would allow me to detect this'] },
  { id:'q29', sec:4, type:'textarea', isAI:true, text:'When you encounter work you suspect was AI-assisted, how does it differ from authentic student work in terms of biological reasoning quality?' },

  // SECTION 5
  { id:'q30', sec:5, type:'likert', text:'Ability to use standard laboratory equipment (pipettes, microscopes, centrifuges, etc.):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q31', sec:5, type:'likert', text:'Ability to follow multi-step laboratory protocols accurately:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q32', sec:5, type:'likert', text:'Ability to record, organize, and present laboratory data in a scientific format:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q33', sec:5, type:'likert', text:'Understanding of laboratory safety protocols:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q34', sec:5, type:'radio', text:'Are students who completed AP Biology laboratory investigations better prepared for college lab work than those who did not?', options:['Yes, considerably better prepared','Yes, somewhat better prepared','Generally about the same','In some areas better, in other areas not','Generally not better prepared','I do not have enough information to assess this'] },
  { id:'q35', sec:5, type:'textarea', text:'What specific laboratory skills are most underdeveloped in incoming students, regardless of AP Biology background?' },
  { id:'q36', sec:5, type:'checkbox', isAI:true, text:'Do you use any technology or AI-based tools in your laboratory courses? (Select all that apply)', options:['Virtual laboratory simulations (e.g., Labster, PhET)','AI-assisted data analysis or visualization tools','Computer-based microscopy or imaging software','Bioinformatics tools or genomic databases (e.g., NCBI, BLAST)','General AI assistants (e.g., ChatGPT, Claude) for pre/post-lab work','I do not use technology-based or AI tools in laboratory instruction','Other'] },
  { id:'q37', sec:5, type:'radio', isAI:true, text:'Should AP Biology courses incorporate more technology-based or AI-assisted laboratory simulations to supplement or replace physical lab work?', options:['Yes, technology-based labs can be as effective as physical labs for most skills','Yes, as a supplement but not a replacement for hands-on physical labs','No, physical laboratory experience is essential and should not be reduced','I do not have a strong opinion on this','Other'] },

  // SECTION 6
  { id:'q38', sec:6, type:'likert', text:'Ability to read and comprehend primary scientific literature (journal articles, research papers):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q39', sec:6, type:'likert', text:'Ability to write clearly and scientifically (lab reports, essays, short-answer responses):', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q40', sec:6, type:'likert', text:'Ability to manage time and study effectively for college-level biology coursework:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q41', sec:6, type:'likert', text:'Persistence and willingness to work through problems without immediately seeking the answer:', options:['1 – Very Poor','2 – Below Avg','3 – Average','4 – Above Avg','5 – Excellent'] },
  { id:'q42', sec:6, type:'radio', text:'How well do students demonstrate comfort with academic struggle and productive failure in your course?', options:['Most students show healthy persistence and resilience when challenged','Some students persist but many become discouraged quickly','Most students struggle to persist when faced with difficulty or ambiguity','Student resilience varies widely and I have observed notable changes recently','Other'] },
  { id:'q43', sec:6, type:'radio', isAI:true, text:'How has access to AI tools affected students\' approach to studying and independent problem-solving?', options:['Students are more likely to use AI to immediately find answers rather than working through problems','Students use AI as a study aid in productive ways (e.g., concept explanation, practice problems)','I see both productive and unproductive AI use in roughly equal measure','AI use does not appear to significantly affect how students study','I do not have enough information to assess this'] },
  { id:'q44', sec:6, type:'radio', isAI:true, text:'What is your institution\'s current policy on student use of AI tools in introductory biology coursework?', options:['AI tools are prohibited for all coursework','AI tools are prohibited for some assignments but permitted for others','AI tool use is permitted with proper disclosure/citation','AI tool use is unrestricted','My institution has no formal policy; it is left to individual instructors','I am not aware of a formal institution policy'] },
  { id:'q45', sec:6, type:'textarea', isAI:true, text:'What do you believe the policy on student AI tool use in introductory college biology should be?' },
  { id:'q46', sec:6, type:'radio', isAI:true, text:'Should AP Biology courses explicitly teach students how to use AI tools responsibly as a study and research aid?', options:['Yes, this should be a formal part of the curriculum','Yes, informally as good academic practice','Only if paired with explicit instruction on limitations and academic integrity','No, AI tool use should be discouraged in high school science courses','No opinion'] },

  // SECTION 7
  { id:'q47', sec:7, type:'sub_likert', text:'How important is it for AP Biology courses to emphasize the following? (1 = Not Important, 5 = Critically Important)', subs:[
    'Conceptual understanding over memorization of facts',
    'Practice interpreting and analyzing data from graphs and tables',
    'Open-ended, inquiry-based laboratory investigations',
    'Scientific writing (formal lab reports, written explanations)',
    'Application of concepts to novel real-world or experimental scenarios',
    'Reading and summarizing scientific literature or articles',
    'Practicing exam strategies for long-answer and free-response questions',
    'Developing persistence and tolerance for academic challenge',
    'Teaching responsible and effective use of technology and AI tools',
    'Critical evaluation of AI-generated content for accuracy and scientific validity',
  ], options:['1','2','3','4','5'] },
  { id:'q48', sec:7, type:'textarea', text:'What are the most valuable things a high school biology teacher can do to prepare students for college-level biology? Be as specific as possible:' },
  { id:'q49', sec:7, type:'textarea', text:'What do high school biology teachers most commonly do that inadvertently leaves students underprepared for college biology? Be as specific as possible:' },
  { id:'q50', sec:7, type:'checkbox', isAI:true, text:'Should AP Biology teachers integrate AI tools into instruction in any of the following ways? (Select all that apply)', options:['Using AI to generate hypotheses or brainstorm experimental designs (with critical evaluation)','Assigning students to use and critically evaluate AI-generated biology content','Using AI tools for personalized practice and concept review','Demonstrating how AI tools can produce inaccurate scientific content','Teaching students how to cite and disclose AI tool use appropriately','None — AI tools should not be integrated into AP Biology instruction','Other'] },
  { id:'q51', sec:7, type:'textarea', isAI:true, text:'What specific guidance would you give to an AP Biology teacher on preparing students to navigate AI tools responsibly in a college biology environment?' },

  // SECTION 8
  { id:'q52', sec:8, type:'checkbox', text:'How is the final grade in your introductory biology course primarily determined? (Select all that apply)', options:['Lecture exams / written tests','Laboratory practicals or lab reports','Quizzes (announced or unannounced)','Written assignments or research papers','Participation / in-class activities','Final project or presentation','Standardized or cumulative final exam','Other'] },
  { id:'q53', sec:8, type:'radio', text:'Approximately what percentage of the final grade is determined by major exams (midterms and/or finals)?', options:['Less than 25%','25–40%','41–60%','61–75%','More than 75%'] },
  { id:'q54', sec:8, type:'radio', text:'Do you offer opportunities for students to retake or reassess major exams?', options:['Yes, students may retake full major exams','Yes, but only certain portions or selected questions','Yes, in certain circumstances (e.g., documented illness or emergency only)','No, major exams are not retaken but other work can substitute for a low score','No, major exams cannot be retaken or replaced under any circumstance'] },
  { id:'q55', sec:8, type:'textarea', text:'If you offer any form of exam reassessment or grade recovery, please describe the policy (conditions, score caps, effort requirements):' },
  { id:'q56', sec:8, type:'radio', text:'Do students receive ongoing formative feedback throughout the term?', options:['Yes, frequently — students receive regular formative feedback throughout the course','Yes, occasionally — some formative feedback is provided but not consistently','Rarely — most feedback comes from major graded assessments','No — graded assessments are the primary means by which students gauge their progress'] },
  { id:'q57', sec:8, type:'radio', text:'How do you handle late work in your course?', options:['Late work is accepted with no penalty','Late work is accepted with a point deduction','Late work is accepted within a set window (e.g., 24–72 hours) with or without penalty','Late work is generally not accepted except under documented extenuating circumstances','Late work is never accepted','Policy varies by assignment type'] },
  { id:'q58', sec:8, type:'radio', isAI:true, text:'Do you use any AI-based tools to detect AI-generated student work?', options:['Yes, routinely for all submitted work','Yes, selectively when I have reason to suspect AI use','No, but I am considering it','No, and I do not plan to use AI detection tools','My institution prohibits or discourages third-party AI detection tools'] },
  { id:'q59', sec:8, type:'likert', isAI:true, text:'How confident are you in your ability to identify AI-generated or AI-assisted work without detection software?', options:['Not at all Confident','Slightly Confident','Moderately Confident','Very Confident','Extremely Confident'] },
  { id:'q60', sec:8, type:'textarea', isAI:true, text:'Are there other classroom policies regarding technology or AI tool use that AP Biology teachers should be aware of?' },

  // SECTION 9
  { id:'q61', sec:9, type:'number', text:'On a scale of 1–10 (1 = Not at all prepared, 10 = Exceptionally prepared), what number best represents the average preparedness of students entering your introductory biology course?' },
  { id:'q62', sec:9, type:'textarea', text:'If you could send one message to every AP Biology teacher in the country about preparing students for college-level biology, what would you say?' },
  { id:'q63', sec:9, type:'textarea', isAI:true, text:'Looking broadly at the future of biology education, how do you think AI tools will most significantly change what students need to know and be able to do when they arrive in college?' },
  { id:'q64', sec:9, type:'textarea', isAI:true, text:'Are there AI or technology-related skills you now consider essential for incoming biology students? If so, what are they?' },
  { id:'q65', sec:9, type:'textarea', text:'Is there anything important about student preparedness or the high school to college transition that this survey did not address? Please share any additional thoughts:' },
];

// ═══════════════════════════════════ SURVEY STATE
let currentSection = 1;
let responses = {};

function getSectionQuestions(secNum) {
  return QUESTIONS.filter(q => q.sec === secNum);
}

function startSurvey() {
  showView('survey');
  currentSection = 1;
  responses = {};
  renderSection(currentSection);
}

function renderSection(secNum) {
  const section = SECTIONS.find(s => s.num === secNum);
  const questions = getSectionQuestions(secNum);
  let html = `<div class="section-header animate-in">
    <div class="section-num-badge">Section ${secNum} of ${SECTIONS.length}</div>
    <h2>${section.title}</h2>
    ${section.note ? `<p class="section-note">${section.note}</p>` : ''}
  </div>`;

  questions.forEach((q, idx) => {
    const qNum = QUESTIONS.indexOf(q) + 1;
    const aiClass = q.isAI ? ' ai-question' : '';
    html += `<div class="question-block${aiClass}" id="block-${q.id}">`;
    if (q.isAI) html += `<div class="ai-tag">⬡ Technology &amp; AI</div>`;
    html += `<div class="q-num">Q${qNum}</div>`;
    html += `<div class="q-text">${q.text}</div>`;

    if (q.type === 'radio') {
      html += `<div class="options-list">`;
      q.options.forEach(opt => {
        const checked = responses[q.id] === opt ? 'checked' : '';
        html += `<label class="option-label${responses[q.id]===opt?' selected':''}">
          <input type="radio" name="${q.id}" value="${opt}" ${checked} onchange="recordResponse('${q.id}', this.value)">
          ${opt}
        </label>`;
      });
      html += `</div>`;

    } else if (q.type === 'checkbox') {
      html += `<div class="options-list">`;
      q.options.forEach(opt => {
        const stored = responses[q.id] || [];
        const checked = stored.includes(opt) ? 'checked' : '';
        html += `<label class="option-label${stored.includes(opt)?' selected':''}">
          <input type="checkbox" name="${q.id}" value="${opt}" ${checked} onchange="recordCheckbox('${q.id}', this.value, this.checked)">
          ${opt}
        </label>`;
      });
      html += `</div>`;

    } else if (q.type === 'likert') {
      html += `<div class="likert-wrap"><table class="likert-table"><thead><tr>`;
      q.options.forEach(opt => { html += `<th>${opt}</th>`; });
      html += `</tr></thead><tbody><tr>`;
      q.options.forEach((opt, i) => {
        const checked = responses[q.id] == (i+1) ? 'checked' : '';
        html += `<td><input type="radio" name="${q.id}" value="${i+1}" ${checked} onchange="recordResponse('${q.id}', this.value)"></td>`;
      });
      html += `</tr></tbody></table></div>`;

    } else if (q.type === 'textarea') {
      const val = responses[q.id] || '';
      html += `<textarea class="survey-textarea" rows="4" onchange="recordResponse('${q.id}', this.value)" oninput="recordResponse('${q.id}', this.value)">${val}</textarea>`;

    } else if (q.type === 'number') {
      const val = responses[q.id] || '';
      html += `<input type="number" min="1" max="10" value="${val}" style="border:1px solid var(--border);padding:12px 16px;font-size:20px;font-family:'Cormorant Garamond',serif;width:100px;background:var(--cream);outline:none;" onchange="recordResponse('${q.id}', this.value)">
      <span style="font-size:13px;color:var(--text-light);margin-left:12px;">Enter a number from 1 to 10</span>`;

    } else if (q.type === 'sub_likert') {
      html += `<div style="overflow-x:auto;"><table class="likert-table" style="min-width:520px;">
        <thead><tr><th style="text-align:left;width:55%;">Area</th>`;
      q.options.forEach(o => { html += `<th>${o}</th>`; });
      html += `</tr></thead><tbody>`;
      q.subs.forEach((sub, si) => {
        html += `<tr style="border-bottom:1px solid var(--cream-dark);">
          <td style="text-align:left;padding:10px 12px;font-size:13px;color:var(--text-mid);">${sub}</td>`;
        q.options.forEach((opt, oi) => {
          const stored = responses[q.id] || {};
          const checked = stored[si] == (oi+1) ? 'checked' : '';
          html += `<td><input type="radio" name="${q.id}_${si}" value="${oi+1}" ${checked} onchange="recordSubLikert('${q.id}', ${si}, this.value)"></td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table></div>`;
    }

    html += `</div>`;
  });

  // Navigation
  const isFirst = secNum === 1;
  const isLast = secNum === SECTIONS.length;
  html += `<div class="survey-nav">`;
  if (!isFirst) {
    html += `<button class="nav-btn nav-btn-prev" onclick="goSection(${secNum-1})">← Previous</button>`;
  } else {
    html += `<button class="nav-btn nav-btn-prev" onclick="showView('home')">← Back to Home</button>`;
  }
  html += `<span class="section-pill">Section ${secNum} of ${SECTIONS.length}</span>`;
  if (!isLast) {
    html += `<button class="nav-btn nav-btn-next" onclick="goSection(${secNum+1})">Next →</button>`;
  } else {
    html += `<button class="nav-btn nav-btn-submit" onclick="submitSurvey()">Submit Survey ✓</button>`;
  }
  html += `</div>`;

  document.getElementById('survey-body').innerHTML = html;
  document.getElementById('survey-body').scrollTop = 0;
  window.scrollTo(0, 0);

  // Update progress
  const pct = Math.round((secNum / SECTIONS.length) * 100);
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-label').textContent = `Section ${secNum} of ${SECTIONS.length}`;
  document.getElementById('current-section-label').textContent = section.title;
}

function recordResponse(id, val) {
  responses[id] = val;
}

function recordCheckbox(id, val, checked) {
  if (!responses[id]) responses[id] = [];
  if (checked) {
    if (!responses[id].includes(val)) responses[id].push(val);
  } else {
    responses[id] = responses[id].filter(v => v !== val);
  }
  // Update selected class
  document.querySelectorAll(`input[name="${id}"]`).forEach(inp => {
    inp.closest('.option-label').classList.toggle('selected', inp.checked);
  });
}

function recordSubLikert(id, subIdx, val) {
  if (!responses[id]) responses[id] = {};
  responses[id][subIdx] = val;
}

function goSection(num) {
  currentSection = num;
  renderSection(num);
}

async function submitSurvey() {
  const btn = document.querySelector('.nav-btn-submit');
  if (btn) { btn.textContent = 'Submitting…'; btn.disabled = true; }
  try {
    await addResponse({...responses});
    renderSuccess();
  } catch(e) {
    if (btn) { btn.textContent = 'Submit Survey ✓'; btn.disabled = false; }
    alert('There was an error submitting your response. Please try again.');
  }
}

function renderSuccess() {
  document.getElementById('survey-body').innerHTML = `
    <div class="success-screen animate-in">
      <div class="success-icon">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
      </div>
      <h2>Thank You!</h2>
      <p>Your response has been recorded. Your insights are greatly valued and will contribute to improving how AP Biology teachers prepare students for college-level biology.</p>
      <p>All responses are anonymous and will be reported only in aggregate. If you would like to discuss the results or your perspectives on science education, please contact:</p>
      <p style="background:var(--cream-dark);padding:16px 24px;font-family:'DM Mono',monospace;font-size:13px;color:var(--navy);margin-top:8px;">
        Dustin Houghton, PhD &middot; AP Biology Teacher<br>dhoughto&#64;ccs&#46;k12&#46;in&#46;us
      </p>
      <br>
      <button class="nav-btn nav-btn-prev" onclick="showView('home')" style="margin-top:16px;">← Return to Homepage</button>
    </div>`;
  window.scrollTo(0, 0);
}

// ═══════════════════════════════════ VIEWS
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  if (name === 'admin') {
    document.getElementById('admin').style.display = 'block';
  } else {
    document.getElementById('admin').style.display = 'none';
  }
}

// ═══════════════════════════════════ ADMIN AUTH
function openAdminModal() {
  document.getElementById('admin-modal').classList.add('open');
  document.getElementById('admin-pw-input').value = '';
  document.getElementById('login-error').style.display = 'none';
  setTimeout(() => document.getElementById('admin-pw-input').focus(), 100);
}

function closeAdminModal() {
  document.getElementById('admin-modal').classList.remove('open');
}

async function checkAdminLogin() {
  const pw = document.getElementById('admin-pw-input').value;
  const btn = document.querySelector('#admin-modal .btn-primary');
  btn.textContent = 'Logging in…'; btn.disabled = true;
  const result = await apiPost('/api/admin/login', { password: pw });
  btn.textContent = 'Log In'; btn.disabled = false;
  if (result.ok) {
    closeAdminModal();
    openAdmin();
  } else {
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('admin-pw-input').value = '';
    document.getElementById('admin-pw-input').focus();
  }
}

function openAdmin() {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('admin').style.display = 'block';
  document.getElementById('admin').classList.add('active');
  showAdminTab('dashboard');
  loadDashboard();
}

async function adminLogout() {
  await apiPost('/api/admin/logout', {});
  document.getElementById('admin').classList.remove('active');
  document.getElementById('admin').style.display = 'none';
  document.getElementById('home').classList.add('active');
}

// ═══════════════════════════════════ ADMIN TABS
function showAdminTab(tab) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.admin-nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  document.querySelectorAll('.admin-nav-item').forEach(n => {
    if (n.textContent.trim().toLowerCase().startsWith(tab === 'dashboard' ? 'dash' : tab === 'responses' ? 'indiv' : 'set')) {
      n.classList.add('active');
    }
  });
  if (tab === 'responses') loadResponses();
  if (tab === 'dashboard') loadDashboard();
}

// ═══════════════════════════════════ DASHBOARD
async function loadDashboard() {
  const result = await apiGet('/api/admin/aggregate');
  if (!result.ok) return;
  const agg = result.data;

  document.getElementById('stat-total').textContent = agg.total || 0;
  document.getElementById('stat-avg-prep').textContent = agg.avgPrep || '—';

  // Top trend label
  const trendLabels = {
    'Students have become noticeably more prepared': '↑ More Prepared',
    'Students have become somewhat more prepared':   '↑ More Prepared',
    'Preparedness has remained about the same':      '→ Same',
    'Students have become somewhat less prepared':   '↓ Less Prepared',
    'Students have become noticeably less prepared': '↓ Less Prepared',
  };
  if (agg.topTrend) {
    document.getElementById('stat-trend').textContent = trendLabels[agg.topTrend[0]] || agg.topTrend[0].substring(0,14);
  } else {
    document.getElementById('stat-trend').textContent = '—';
  }
  document.getElementById('stat-ai-detect').textContent = agg.detectYesPct !== null ? agg.detectYesPct + '%' : '—';

  if (agg.total === 0) {
    document.getElementById('aggregate-charts').innerHTML = `<div class="empty-state">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      <h3>No responses yet</h3><p>Aggregate charts will appear here once responses are submitted.</p></div>`;
    return;
  }

  let chartsHtml = '';
  const c = agg.charts;
  chartsHtml += buildBarChartFromCounts('Institution Type Distribution', 'Q1: What type of institution do you teach at?', c.q1, ['R1/R2 Doctoral University (high or very high research activity)','Master\'s University','Liberal Arts College / Baccalaureate College','Community College or Two-Year Institution','Other'], agg.total);
  chartsHtml += buildBarChartFromCounts('Preparedness Trend (Past 5 Years)', 'Q7: How would you describe the trend in incoming student preparedness?', c.q7, ['Students have become noticeably more prepared','Students have become somewhat more prepared','Preparedness has remained about the same','Students have become somewhat less prepared','Students have become noticeably less prepared'], agg.total);
  chartsHtml += buildBarChartFromCounts('Overall Preparedness Rating', 'Q6: Rate overall preparedness of incoming students:', c.q6, ['1','2','3','4','5'], agg.total, ['Very Underprepared','Somewhat Underprepared','Adequately Prepared','Well Prepared','Exceptionally Prepared']);
  chartsHtml += buildBarChartFromCounts('AP vs Non-AP: Critical Thinking', 'Q25: How do AP Biology students compare to non-AP students in critical thinking?', c.q25, ['AP Biology students demonstrate noticeably stronger critical thinking skills','AP Biology students demonstrate somewhat stronger critical thinking skills','There is no consistent difference between the two groups','AP Biology students demonstrate somewhat weaker critical thinking in some areas','AP Biology students demonstrate noticeably weaker critical thinking in some areas','I have not observed a pattern I am confident about'], agg.total);
  chartsHtml += buildBarChartFromCounts('AI Impact on Study Habits', 'Q43: How has AI access affected students\' approach to studying?', c.q43, ['Students are more likely to use AI to immediately find answers rather than working through problems','Students use AI as a study aid in productive ways (e.g., concept explanation, practice problems)','I see both productive and unproductive AI use in roughly equal measure','AI use does not appear to significantly affect how students study','I do not have enough information to assess this'], agg.total);
  chartsHtml += buildBarChartFromCounts('Major Exam Reassessment Policy', 'Q54: Do you offer opportunities for students to retake or reassess major exams?', c.q54, ['Yes, students may retake full major exams','Yes, but only certain portions or selected questions','Yes, in certain circumstances (e.g., documented illness or emergency only)','No, major exams are not retaken but other work can substitute for a low score','No, major exams cannot be retaken or replaced under any circumstance'], agg.total);
  chartsHtml += buildBarChartFromCounts('AI Detection Tool Usage', 'Q58: Do you use AI-based tools to detect AI-generated student work?', c.q58, ['Yes, routinely for all submitted work','Yes, selectively when I have reason to suspect AI use','No, but I am considering it','No, and I do not plan to use AI detection tools','My institution prohibits or discourages third-party AI detection tools'], agg.total);

  document.getElementById('aggregate-charts').innerHTML = chartsHtml;
}

function buildBarChartFromCounts(title, question, counts, options, total, optionLabels) {
  const labels = optionLabels || options;
  const effectiveTotal = Object.values(counts || {}).reduce((a,b)=>a+b,0) || 1;
  let html = `<div class="agg-section"><h3>${title}</h3><div class="agg-q">${question}</div><div class="bar-chart">`;
  options.forEach((opt, i) => {
    const count = (counts && counts[opt]) || 0;
    const pct = Math.round(count / effectiveTotal * 100);
    html += `<div class="bar-row">
      <div class="bar-row-label">${labels[i] || opt}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
      <div class="bar-count">${count} <span style="color:#bbb;">(${pct}%)</span></div>
    </div>`;
  });
  html += `</div></div>`;
  return html;
}

// ═══════════════════════════════════ RESPONSES
let allResponsesCache = [];
let filteredResponses = [];

async function loadResponses() {
  const result = await apiGet('/api/admin/responses');
  if (!result.ok) return;
  allResponsesCache = result.data;
  filteredResponses = [...allResponsesCache];
  renderResponsesTable(filteredResponses);
}

function filterResponses() {
  const term = document.getElementById('response-search').value.toLowerCase();
  filteredResponses = allResponsesCache.filter(r => {
    const ts = new Date(r.created).toLocaleDateString();
    const inst = (r.q1 || '').toLowerCase();
    return ts.includes(term) || inst.includes(term);
  });
  renderResponsesTable(filteredResponses);
}

function renderResponsesTable(responses) {
  document.getElementById('response-count-label').textContent = `${responses.length} response${responses.length!==1?'s':''}`;

  if (responses.length === 0) {
    document.getElementById('responses-table-wrap').innerHTML = `<div class="empty-state">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
      <h3>No responses found</h3><p>Submitted responses will appear here.</p></div>`;
    return;
  }

  let html = `<table class="responses-table"><thead><tr>
    <th>#</th><th>Submitted</th><th>Institution Type</th><th>Teaching Area</th><th>Prep Score</th><th>Actions</th>
  </tr></thead><tbody>`;

  responses.forEach((r, i) => {
    const ts = new Date(r.created).toLocaleString();
    const inst = r.q1 ? r.q1.split('(')[0].trim().substring(0,30) : '—';
    const area = r.q3 ? r.q3.substring(0,25) : '—';
    const prep = r.q61 || '—';
    html += `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-light);">${r.id}</td>
      <td style="white-space:nowrap;">${ts}</td>
      <td>${inst}</td>
      <td>${area}</td>
      <td><strong style="font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--navy);">${prep}</strong>/10</td>
      <td>
        <button class="view-response-btn" onclick="viewResponse(${r.id})">View</button>
        <button class="delete-btn" onclick="deleteResponse(${r.id})">Delete</button>
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById('responses-table-wrap').innerHTML = html;
}

async function viewResponse(id) {
  const result = await apiGet(`/api/admin/responses/${id}`);
  if (!result.ok) return;
  const r = result.data;

  let html = `<h3>Response #${r.id}</h3>
    <div class="response-meta">${new Date(r.created).toLocaleString()} · ${r.data.q1 || 'Institution not specified'}</div>`;

  QUESTIONS.forEach((q, i) => {
    const val = r.data[q.id];
    if (!val || (Array.isArray(val) && val.length === 0)) return;
    let displayVal = '';
    if (Array.isArray(val)) {
      displayVal = val.join('; ');
    } else if (typeof val === 'object') {
      displayVal = Object.entries(val).map(([k,v]) => `${q.subs ? q.subs[k] : k}: ${v}`).join('<br>');
    } else {
      displayVal = String(val);
    }
    html += `<div class="response-item">
      <div class="r-q">Q${i+1}. ${q.text}</div>
      <div class="r-a">${displayVal}</div>
    </div>`;
  });

  document.getElementById('response-detail-content').innerHTML = html;
  document.getElementById('response-modal').classList.add('open');
}

function closeResponseModal() {
  document.getElementById('response-modal').classList.remove('open');
}

async function deleteResponse(id) {
  if (!confirm('Delete this response? This cannot be undone.')) return;
  const result = await apiDelete(`/api/admin/responses/${id}`);
  if (result.ok) {
    loadResponses();
    loadDashboard();
  }
}

// ═══════════════════════════════════ SETTINGS
async function changePassword() {
  const curr  = document.getElementById('settings-current-pw').value;
  const newPw = document.getElementById('settings-new-pw').value;
  const conf  = document.getElementById('settings-confirm-pw').value;
  const errEl = document.getElementById('settings-error');

  errEl.style.display = 'none';
  document.getElementById('settings-success').style.display = 'none';

  if (newPw !== conf) {
    errEl.textContent = 'New passwords do not match.';
    errEl.style.display = 'block'; return;
  }
  if (newPw.length < 6) {
    errEl.textContent = 'New password must be at least 6 characters.';
    errEl.style.display = 'block'; return;
  }

  const result = await apiPost('/api/admin/password', { current: curr, newPassword: newPw, confirm: conf });
  if (!result.ok) {
    errEl.textContent = result.data.error || 'An error occurred.';
    errEl.style.display = 'block'; return;
  }

  document.getElementById('settings-current-pw').value = '';
  document.getElementById('settings-new-pw').value = '';
  document.getElementById('settings-confirm-pw').value = '';
  document.getElementById('settings-success').style.display = 'block';
}

function exportData() {
  window.location.href = '/api/admin/export';
}

async function confirmDeleteAll() {
  if (confirm('This will permanently delete ALL survey responses. This action cannot be undone. Are you absolutely sure?')) {
    if (confirm('Final confirmation: delete all responses?')) {
      await apiDelete('/api/admin/responses');
      loadResponses();
      loadDashboard();
    }
  }
}

// Close modals on outside click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) {
      overlay.classList.remove('open');
    }
  });
});

// Option label click styling
document.addEventListener('change', e => {
  if (e.target.type === 'radio' && e.target.closest('.options-l